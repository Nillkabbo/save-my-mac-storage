<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>macOS Cleaner - System Analysis</title>
    <!-- Use native system fonts for a professional feel -->
    <style>
        :root {
            --sidebar-width: 260px;
            --accent-blue: #007AFF;
            --bg-main: #FBFBFB;
            --bg-sidebar: #ECECEC;
            --border-color: #D1D1D1;
            --text-primary: #1D1D1F;
            --text-secondary: #6E6E73;
            --card-bg: #FFFFFF;
            --row-hover: #F2F2F7;
            --success-green: #28CD41;
            --error-red: #FF3B30;
            --warning-orange: #FF9500;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-main: #1E1E1E;
                --bg-sidebar: #2D2D2D;
                --border-color: #404040;
                --text-primary: #FFFFFF;
                --text-secondary: #A1A1A6;
                --card-bg: #2C2C2C;
                --row-hover: #3A3A3C;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 0 20px 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .sidebar-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            padding: 8px 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            transition: background 0.1s;
        }

        .nav-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .nav-item.active {
            background-color: var(--accent-blue);
            color: white;
        }

        .nav-item.active svg {
            fill: white;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            height: 52px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background-color: var(--bg-main);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .top-bar-title {
            font-size: 16px;
            font-weight: 600;
        }

        .view-container {
            padding: 24px;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        /* Components */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 8px 12px;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-main);
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover td {
            background-color: var(--row-hover);
        }

        .btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.1s;
        }

        .btn:hover {
            background-color: var(--row-hover);
        }

        .btn-primary {
            background-color: var(--accent-blue);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background-color: #0062CC;
        }

        .btn-primary:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        /* Progress Bar */
        .progress-container {
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent-blue);
            transition: width 0.3s ease;
        }

        /* Status Badges */
        .badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-safe {
            background-color: rgba(40, 205, 65, 0.1);
            color: var(--success-green);
        }

        .badge-warning {
            background-color: rgba(255, 149, 0, 0.1);
            color: var(--warning-orange);
        }

        .badge-error {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--error-red);
        }

        .hidden {
            display: none;
        }

        /* Icons */
        .icon {
            width: 16px;
            height: 16px;
            fill: var(--text-secondary);
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">macOS Cleaner</div>
        </div>
        <div class="nav-item active" onclick="switchView('overview')">
            <span>üè†</span> Overview
        </div>
        <div class="nav-item" onclick="switchView('recommendations')">
            <span>üéØ</span> Recommendations
        </div>
        <div class="nav-item" onclick="switchView('categories')">
            <span>üìÅ</span> Folders
        </div>
        <div class="nav-item" onclick="switchView('files')">
            <span>üìÑ</span> Large Files
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="top-bar-title" id="view-title">System Overview</div>
            <button class="btn btn-primary" id="analyze-btn" onclick="startAnalysis()">Analyze System</button>
        </div>

        <div class="view-container">
            <!-- Overview View -->
            <div id="view-overview">
                <div class="card">
                    <div class="section-title">Disk Usage Analysis</div>
                    <div id="disk-info">
                        <p style="color: var(--text-secondary);">Click Analyze to scan your system.</p>
                    </div>
                </div>

                <div class="card hidden" id="status-card">
                    <div class="section-title">Scan Status</div>
                    <div id="status-msg" style="font-size: 14px; margin-bottom: 8px;">Preparing analysis...</div>
                    <div class="progress-container">
                        <div class="progress-fill" id="prog-bar" style="width: 0%"></div>
                    </div>
                    <div id="prog-text" style="font-size: 12px; color: var(--text-secondary);">0% complete</div>
                </div>

                <div class="stats-grid hidden" id="summary-stats">
                    <div class="stat-card">
                        <div class="stat-label">Potential Savings</div>
                        <div class="stat-value" id="stat-savings">0 B</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Files Identified</div>
                        <div class="stat-value" id="stat-files">0</div>
                    </div>
                </div>
            </div>

            <!-- Recommendations View -->
            <div id="view-recommendations" class="hidden">
                <div class="card">
                    <div class="section-title">Optimization Recommendations</div>
                    <table id="recommendations-table">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>Reason</th>
                                <th>Size</th>
                                <th>Safety</th>
                            </tr>
                        </thead>
                        <tbody id="recommendations-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Categories View -->
            <div id="view-categories" class="hidden">
                <div class="card">
                    <div class="section-title">System Folders</div>
                    <table id="categories-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Path</th>
                                <th>Identified Size</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="categories-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Large Files View -->
            <div id="view-files" class="hidden">
                <div class="card">
                    <div class="section-title">Large Files Identified</div>
                    <table id="files-table">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Path</th>
                                <th>Size</th>
                                <th>Age</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="files-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const csrfToken = "{{ csrf_token() }}";
        let currentReport = null;

        function switchView(viewId) {
            // Update Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update View
            document.querySelectorAll('.view-container > div').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById('view-' + viewId).classList.remove('hidden');

            // Update Title
            const titles = {
                'overview': 'System Overview',
                'recommendations': 'Recommendations',
                'categories': 'System Folders',
                'files': 'Large Files'
            };
            document.getElementById('view-title').innerText = titles[viewId];
        }

        function startAnalysis() {
            const btn = document.getElementById('analyze-btn');
            btn.disabled = true;
            btn.innerText = 'Analyzing...';

            document.getElementById('status-card').classList.remove('hidden');
            
            fetch('/api/analyze')
                .then(r => r.json())
                .then(data => {
                    if (data.success) monitorStatus();
                    else alert(data.error);
                })
                .catch(e => alert("Analysis failed to start"));
        }

        function monitorStatus() {
            const interval = setInterval(() => {
                fetch('/api/status')
                    .then(r => r.json())
                    .then(data => {
                        const progBar = document.getElementById('prog-bar');
                        const progText = document.getElementById('prog-text');
                        const statusMsg = document.getElementById('status-msg');

                        progBar.style.width = data.progress + '%';
                        progText.innerText = data.progress + '% complete';
                        statusMsg.innerText = data.message || "Working...";

                        if (data.status === 'completed') {
                            clearInterval(interval);
                            handleCompletion(data.results);
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            alert(data.message);
                        }
                    });
            }, 800);
        }

        function handleCompletion(report) {
            const btn = document.getElementById('analyze-btn');
            btn.disabled = false;
            btn.innerText = 'Re-Analyze';

            document.getElementById('summary-stats').classList.remove('hidden');
            document.getElementById('stat-savings').innerText = report.space_analyzed_human || "0 B";
            document.getElementById('stat-files').innerText = report.files_analyzed || "0";

            renderDiskInfo(report.disk_usage);
            renderRecommendations(report.top_recommendations);
            renderCategories(report.user_directories.directories);
            renderLargeFiles(report.large_files);
        }

        function renderDiskInfo(disk) {
            const html = `
                <div style="font-size: 14px; margin-bottom: 12px;">
                    <strong>Disk Usage:</strong> ${(disk.used / 1024**3).toFixed(1)} GB of ${(disk.total / 1024**3).toFixed(1)} GB used (${disk.usage_percent.toFixed(1)}%)
                </div>
                <div class="progress-container">
                    <div class="progress-fill" style="width: ${disk.usage_percent}%"></div>
                </div>
            `;
            document.getElementById('disk-info').innerHTML = html;
        }

        function renderRecommendations(recs) {
            const body = document.getElementById('recommendations-body');
            body.innerHTML = recs.slice(0, 10).map(rec => `
                <tr>
                    <td><strong>${rec.location}</strong></td>
                    <td>${rec.reason}</td>
                    <td>${rec.size_human}</td>
                    <td><span class="badge badge-${rec.priority === 'high' ? 'error' : (rec.priority === 'medium' ? 'warning' : 'safe')}">${rec.priority}</span></td>
                </tr>
            `).join('');
        }

        function renderCategories(dirs) {
            const body = document.getElementById('categories-body');
            body.innerHTML = Object.entries(dirs).map(([name, info]) => `
                <tr>
                    <td><strong>${name}</strong></td>
                    <td style="color: var(--text-secondary); font-family: monospace;">${info.path}</td>
                    <td>${info.size_human}</td>
                    <td><button class="btn" onclick="openFinder('${info.path}')">Open</button></td>
                </tr>
            `).join('');
        }

        function renderLargeFiles(files) {
            const body = document.getElementById('files-body');
            body.innerHTML = files.slice(0, 50).map(file => `
                <tr>
                    <td><strong>${file.path.split('/').pop()}</strong></td>
                    <td style="color: var(--text-secondary); font-family: monospace; font-size: 11px;">${file.path}</td>
                    <td>${file.size_human}</td>
                    <td>${file.age_days}d</td>
                    <td><button class="btn" onclick="openFinder('${file.path}')">Show</button></td>
                </tr>
            `).join('');
        }

        function openFinder(path) {
            fetch('/api/open_finder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ path: path })
            }).then(r => r.json()).then(d => {
                if (!d.success) alert(d.error);
            });
        }
    </script>
</body>

</html>